{% extends "base.html" %}

{% load static %}

{% block title %}
post list
{% endblock title %}



{% block content %}

{% if messages %}
{% for message in messages %}
<li> {{ message }} </li>
{% endfor %}

{% endif %}

<h1>Post list</h1>
<a href="{% url 'create_post' %} " class="btn btn-primary">Add post</a>
<br>
<br>
<!-- <div>
  {% for post in posts %}

  {% with total_post_like=post.users_like.count total_post_user=post.users_like.all %}



  <div>
    <P> {{ post.content}} </P>
    {% if post.post_media.all %}
    {% for image in post.post_media.all %}
    {% if image.image %}
    <img src="{{ image.image.url }} " alt="" height="350" width="400">
    {% endif %}
    {% endfor %}

    {% endif %}
    <p>{{ post.owner }} </p>

    {% include 'apps/partial/like_item.html' with total_like=total_post_like total_user=total_post_user model='post' item=post %}

    <p><a href="{% url 'update_post' post.id %} ">Update post</a></p>
    <p><a href="{% url 'add_comment' post.id %} ">Add comment</a></p>
    {% if post.post_comment.all %}
    {% for comment in post.post_comment.all %}

    {% with total_com_like=comment.users_like.count total_com_user=comment.users_like.all %}

    <li>
      {{ comment }}
      <span>
        <a href="{% url 'update_comment' post.id comment.id %}"> Edit </a>
      </span>
      {% include 'apps/partial/like_item.html' with total_like=total_com_like total_user=total_com_user model='comment' item=comment %}

    </li>
    {% endwith %}
    {% endfor %}

    {% endif %}
  </div>
  {% if not forloop.last %}
  <hr>
  {% endif %}
  {% endwith %}
  {% endfor %}
</div> -->

  {% for post in posts %}
    {% with total_post_like=post.users_like.count total_post_user=post.users_like.all %}

      <div class="container">
        <div class="col-md-7">
          <div class="social-feed-separated">
            <div class="social-avatar">
              <a href="">
                <img alt="image" src="https://bootdey.com/img/Content/avatar/avatar1.png">
              </a>
            </div>

            <div class="social-feed-box">
              <div class="pull-right social-action dropdown">
                <button data-toggle="dropdown" class="dropdown-toggle btn-white">
                  <i class="fa fa-angle-down"></i>
                </button>
                <ul class="dropdown-menu m-t-xs">
                  <li><a href="#">Config</a></li>
                </ul>
              </div>
              <div class="social-avatar">
                <a href="#">
                  {{  post.owner }}
                </a>
                <small class="text-muted">{{ post.created_at }}</small>
              </div>
              <div class="social-body">
                <p>
                  {{ post.content }}
                </p>
                <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="img-responsive">
                <div class="btn-group">
                  <!-- <button class="btn btn-white btn-xs"><i class="fa fa-thumbs-up"></i> {{ total_post_like }} Like this!</button> -->
                  {% include 'apps/partial/like_item.html' with total_like=total_post_like total_user=total_post_user model='post' item=post tag="button" tag_class="btn btn-white btn-xs" %}
                  <button class="btn btn-white btn-xs"><i class="fa fa-comments"></i> Comment</button>
                  <!-- <button class="btn btn-white btn-xs"><i class="fa fa-share"></i> Share</button> -->
                </div>
              </div>
              <div class="social-footer">
                {% for comment in post.post_comment.all %}
                  {% with total_com_like=comment.users_like.count total_com_user=comment.users_like.all %}

                    <div class="social-comment">
                      <a href="" class="pull-left">
                        <img alt="image" src="https://bootdey.com/img/Content/avatar/avatar2.png">
                      </a>
                      <div class="media-body">
                        <a href="#">
                          {{ comment.owner }}
                        </a>
                        {{ comment.content }}
                        <br>
                        <!-- <a href="#" class="small"><i class="fa fa-thumbs-up"></i> {{ total_com_like }} Like this!</a> -
                        <small class="text-muted">12.06.2014</small> -->
                        {% include 'apps/partial/like_item.html' with total_like=total_com_like total_user=total_com_user model='comment' item=comment tag="a" tag_class="small" %} -
                        <small class="text-muted">{{ comment.created_at }}</small>

                      </div>
                    </div>
        
                  {% endwith %}
                {% endfor %}
                  
                <div class="social-comment">
                  <div class="media-body">
                    <textarea class="form-control" placeholder="Write comment..."></textarea>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    {% endwith %}
  {% endfor %}
      
{% endblock content %}

{% block style %}
    <link rel="stylesheet" href=" {% static 'assets/css/feed.css' %} ">
{% endblock style %}

<script>
  const url = '{% url "like_item" %}';
  let options = {
    method: 'POST',
    headers: {
      'X-CSRFToken': cookie
    },
    mode: 'same-origin'
  }

  document.querySelectorAll(".total-post-button").forEach(button => {
    button.addEventListener('click', function (e) {
      let formData = new FormData()
      formData.append('item_id', button.dataset.item_id)
      formData.append('action', button.dataset.action)
      formData.append('model', button.dataset.model)
      options['body'] = formData

      fetch(url, options)
        .then(res => res.json())
        .then(data => {
          if (data['status'] === 'success') {
            let previous = button.dataset.action;
            let action = previous === 'like' ? 'unlike' : 'like';
            button.dataset.action = action
            button.classList.toggle('text-primary')
            

            let span = button.querySelector('span')
            let totalCount = parseInt(span.innerHTML)
            span.innerHTML = previous === 'like' ? totalCount + 1 : totalCount - 1
          }
        })
    })
  })

</script>

{% block dom %}
const cookie = getCookie('csrftoken')
console.log(cookie)
const url = '{% url "like_item" %}';
let options = {
method: 'POST',
headers: {
'X-CSRFToken': cookie
},
mode: 'same-origin'
}

document.querySelectorAll(".total-post-button").forEach(button => {
button.addEventListener('click', function(e){
console.log(button)
let formData = new FormData()
formData.append('item_id', button.dataset.item_id)
formData.append('action', button.dataset.action)
formData.append('model', button.dataset.model )

options['body'] = formData

fetch(url, options)
.then(res => res.json())
.then(data => {
if( data['status'] === 'success'){
let previous = button.dataset.action;
let action = previous === 'like' ? 'unlike' : 'like';
button.dataset.action = action
button.classList.toggle('text-primary')


let span = button.querySelector('span')
let totalCount = parseInt(span.innerHTML)
console.log(totalCount)
span.innerHTML = previous === 'like' ? totalCount + 1 : totalCount - 1
}
})
})
})
{% endblock dom %}