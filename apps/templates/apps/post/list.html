{% extends "base.html" %}

{% load static %}

{% block title %}
post list
{% endblock title %}



{% block content %}

{% if messages %}
{% for message in messages %}
<li> {{ message }} </li>
{% endfor %}

{% endif %}

<h1>Post list</h1>
<a href="{% url 'create_post' %} " class="btn btn-primary">Add post</a>
<br>


<div class="container" >
  <div class="row">
    <div class="col-md-7" id="post-ajax">
      {% include "apps/post/ajax_list.html" %}
    </div>
    <div class="col-md-4">
      {% include 'apps/partial/notifications.html' %}
    </div>
  </div>
</div>
      
{% endblock content %}

{% block style %}
    <link rel="stylesheet" href=" {% static 'assets/css/feed.css' %} ">
{% endblock style %}

<script>
  const url = '{% url "like_item" %}';
  let options = {
    method: 'POST',
    headers: {
      'X-CSRFToken': cookie
    },
    mode: 'same-origin'
  }

  document.querySelectorAll(".total-post-button").forEach(button => {
    button.addEventListener('click', function (e) {
      let formData = new FormData()
      formData.append('item_id', button.dataset.item_id)
      formData.append('action', button.dataset.action)
      formData.append('model', button.dataset.model)
      options['body'] = formData

      fetch(url, options)
        .then(res => res.json())
        .then(data => {
          if (data['status'] === 'success') {
            let previous = button.dataset.action;
            let action = previous === 'like' ? 'unlike' : 'like';
            button.dataset.action = action
            button.classList.toggle('text-primary')
            

            let span = button.querySelector('span')
            let totalCount = parseInt(span.innerHTML)
            span.innerHTML = previous === 'like' ? totalCount + 1 : totalCount - 1
          }
        })
    })
  })

  function paginateWithAjax(){
    let page = 1;
    var emptyPage = false;
    var canRequest = false;

    window.addEventListener('scroll', function(e){
      let marginY =  document.body.clientHeight - window.innerHeight - 200
      if(window.pageYOffset > marginY && !emptyPage && !canRequest){
        canRequest = true;
        page += 1;
        const spinner = `<div class="spinner"> Loading ... </div>`
        var postList = document.querySelector('#post-ajax')
        postList.insertAdjacentHTML('beforeEnd', spinner)
        const targetSpinner = postList.querySelector('.spinner')

        fetch(`?page_only=1&page=${page}`)
          .then(resp => resp.text())
          .then(data => {
            if(data === ''){
              emptyPage = true
              if(targetSpinner){
                postList.removeChild(targetSpinner)
              }
            }
            else{
              postList.removeChild(targetSpinner)
              postList.insertAdjacentHTML('beforeEnd', data)
              canRequest = false
              
            }
          })

      }
      console.log(marginY)

    })
  }

  function addCommentWithAjax(){
    const url = '{% url "add_ajax_comment" %}';
    let options = {
      method: 'POST',
      headers: {
        'X-CSRFToken': cookie
      },
      mode: 'same-origin'
    }

    document.querySelectorAll('.send-comment').forEach(sendButton => {
      sendButton.addEventListener('click', function(e) {
        let socialComment = sendButton.parentNode.parentNode;
        let textarea = socialComment.querySelector('textarea')
        let content = textarea.value
        let post_id = textarea.dataset.id
        console.log(content, post_id)

        let formData = new FormData();
        formData.append('content', content)       
        formData.append('id', post_id)
        options['body'] = formData

        fetch(url, options)
          .then(resp => resp.text())
          .then(data => {
            if (data === 'error'){
              console.log('error')
            }
            else{
              console.log(data)
              socialComment.parentNode.firstElementChild.insertAdjacentHTML('afterbegin', data)
              textarea.value = ''
            }
          })
      })
    })
  }

  paginateWithAjax()

</script>

{% block dom %}
const cookie = getCookie('csrftoken')
console.log(cookie)
const url = '{% url "like_item" %}';
  let options = {
    method: 'POST',
    headers: {
      'X-CSRFToken': cookie
    },
    mode: 'same-origin'
  }

  document.querySelectorAll(".total-post-button").forEach(button => {
    button.addEventListener('click', function (e) {
      let formData = new FormData()
      formData.append('item_id', button.dataset.item_id)
      formData.append('action', button.dataset.action)
      formData.append('model', button.dataset.model)
      options['body'] = formData

      fetch(url, options)
        .then(res => res.json())
        .then(data => {
          if (data['status'] === 'success') {
            let previous = button.dataset.action;
            let action = previous === 'like' ? 'unlike' : 'like';
            button.dataset.action = action
            button.classList.toggle('text-primary')
            

            let span = button.querySelector('span')
            let totalCount = parseInt(span.innerHTML)
            span.innerHTML = previous === 'like' ? totalCount + 1 : totalCount - 1
          }
        })
    })
  })

  function paginateWithAjax(){
    let page = 1;
    var emptyPage = false;
    var canRequest = false;

    window.addEventListener('scroll', function(e){
      let marginY =  document.body.clientHeight - window.innerHeight - 200
      if(window.pageYOffset > marginY && !emptyPage && !canRequest){
        canRequest = true;
        page += 1;
        const spinner = `<div class="spinner"> Loading ... </div>`
        var postList = document.querySelector('#post-ajax')
        postList.insertAdjacentHTML('beforeEnd', spinner)
        const targetSpinner = postList.querySelector('.spinner')

        fetch(`?page_only=1&page=${page}`)
          .then(resp => resp.text())
          .then(data => {
            if(data === ''){
              emptyPage = true
              if(targetSpinner){
                postList.removeChild(targetSpinner)
              }
            }
            else{
              postList.removeChild(targetSpinner)
              postList.insertAdjacentHTML('beforeEnd', data)
              canRequest = false
              
            }
          })

      }
      console.log(marginY)

    })
  }

 function addCommentWithAjax(){
    const url = '{% url "add_ajax_comment" %}';
    let options = {
      method: 'POST',
      headers: {
        'X-CSRFToken': cookie
      },
      mode: 'same-origin'
    }

    document.querySelectorAll('.send-comment').forEach(sendButton => {
      sendButton.addEventListener('click', function(e) {
        let socialComment = sendButton.parentNode.parentNode;
        let textarea = socialComment.querySelector('textarea')
        let content = textarea.value
        let post_id = textarea.dataset.id
        console.log(content, post_id)

        let formData = new FormData();
        formData.append('content', content)       
        formData.append('id', post_id)
        options['body'] = formData

        fetch(url, options)
          .then(resp => resp.text())
          .then(data => {
            if (data === 'error'){
              console.log('error')
            }
            else{
              console.log(data)
              socialComment.parentNode.firstElementChild.insertAdjacentHTML('afterbegin', data)
              textarea.value = ''
            }
          })
      })
    })
  }

  


  addCommentWithAjax()
  paginateWithAjax()
{% endblock dom %}